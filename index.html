<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆ & ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰å…±æœ‰ï¼‰</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Segoe UI','Hiragino Sans','Meiryo',sans-serif;
  min-height:100vh;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);
  display:flex;flex-direction:column;align-items:center;
  padding:40px 20px;
}
h1{color:#fff;font-size:2rem;margin-bottom:8px;text-shadow:0 2px 10px rgba(0,0,0,.2);}
.subtitle{color:rgba(255,255,255,.85);font-size:.95rem;margin-bottom:30px;text-align:center;}
.container{width:100%;max-width:720px;display:flex;flex-direction:column;gap:20px;}
.share-card{
  background:rgba(255,255,255,.95);border-radius:20px;padding:20px 24px;
  box-shadow:0 8px 32px rgba(0,0,0,.15);backdrop-filter:blur(10px);
}
.share-label{font-size:.85rem;color:#999;margin-bottom:8px;font-weight:600;}
.share-url-row{display:flex;gap:8px;align-items:center;}
.share-url-input{
  flex:1;padding:10px 14px;border:2px solid #e0e0e0;border-radius:12px;
  font-size:.85rem;font-family:inherit;color:#333;background:#f8f8ff;
}
.share-url-input:focus{outline:none;border-color:#667eea;}
.global-actions{display:flex;gap:10px;flex-wrap:wrap;}
.global-btn{
  flex:1;min-width:120px;padding:14px 20px;border:none;border-radius:16px;
  font-size:1rem;font-weight:700;cursor:pointer;transition:all .3s;
  display:flex;align-items:center;justify-content:center;gap:6px;
  -webkit-tap-highlight-color:transparent;
}
.global-btn-save{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;box-shadow:0 4px 15px rgba(102,126,234,.3);}
.global-btn-load{background:linear-gradient(135deg,#43e97b,#38f9d7);color:#1a5c3a;box-shadow:0 4px 15px rgba(67,233,123,.3);}
.global-btn-url{background:linear-gradient(135deg,#ffa751,#ffe259);color:#7a5600;box-shadow:0 4px 15px rgba(255,167,81,.3);}
.global-btn:hover{transform:translateY(-2px);}
.global-btn:active{transform:translateY(0);}
.global-btn:disabled{opacity:.6;transform:none;cursor:not-allowed;}
.status{text-align:center;font-size:.8rem;color:rgba(255,255,255,.7);margin-top:-10px;}
.card{
  background:rgba(255,255,255,.95);border-radius:20px;padding:28px;
  box-shadow:0 8px 32px rgba(0,0,0,.15);backdrop-filter:blur(10px);transition:transform .2s;
}
.card:hover{transform:translateY(-2px);}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.card-title{font-size:1.1rem;font-weight:700;}
.badge{
  background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;
  font-size:.75rem;padding:4px 12px;border-radius:20px;font-weight:600;
}
textarea{
  width:100%;min-height:160px;border:2px solid #e0e0e0;border-radius:14px;
  padding:16px;font-size:1rem;font-family:inherit;resize:vertical;
  transition:border-color .3s,box-shadow .3s;line-height:1.7;color:#333;
  white-space:pre-wrap;word-wrap:break-word;
}
textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 4px rgba(102,126,234,.15);}
.slot-label{display:inline-block;font-size:.8rem;color:#999;margin-bottom:8px;}
.btn-group{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap;}
.btn{
  flex:1;min-width:100px;padding:13px 20px;border:none;border-radius:14px;
  font-size:.95rem;font-weight:700;cursor:pointer;transition:all .3s;
  display:flex;align-items:center;justify-content:center;gap:6px;
  -webkit-tap-highlight-color:transparent;
}
.btn-copy{background:linear-gradient(135deg,#43e97b,#38f9d7);color:#1a5c3a;box-shadow:0 4px 15px rgba(67,233,123,.3);}
.btn-add{background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff;box-shadow:0 4px 15px rgba(240,147,251,.3);}
.btn-delete{background:linear-gradient(135deg,#ff6b6b,#ee5a24);color:#fff;box-shadow:0 4px 15px rgba(255,107,107,.3);flex:0;min-width:50px;padding:13px 16px;}
.btn-file{background:linear-gradient(135deg,#ffa751,#ffe259);color:#7a5600;box-shadow:0 4px 15px rgba(255,167,81,.3);}
.btn:hover{transform:translateY(-2px);}
.btn:active{transform:translateY(0);}
.drop-zone{
  margin-top:14px;border:2px dashed #ccc;border-radius:14px;padding:22px;
  text-align:center;color:#999;font-size:.9rem;transition:all .3s;cursor:pointer;
}
.drop-zone.drag-over{border-color:#667eea;background:rgba(102,126,234,.06);color:#667eea;}
.file-list{display:flex;flex-direction:column;gap:10px;margin-top:14px;}
.file-item{
  display:flex;align-items:center;gap:12px;background:#f8f8ff;
  border-radius:12px;padding:12px 16px;transition:background .2s;flex-wrap:wrap;
}
.file-item:hover{background:#eef0ff;}
.file-icon{font-size:1.6rem;flex-shrink:0;}
.file-info{flex:1;min-width:0;}
.file-name{font-weight:600;font-size:.9rem;color:#333;word-break:break-all;}
.file-size{font-size:.75rem;color:#999;}
.file-preview{max-width:100%;max-height:180px;border-radius:10px;margin-top:8px;object-fit:contain;}
.file-actions{display:flex;gap:6px;flex-shrink:0;flex-wrap:wrap;}
.file-btn{
  padding:8px 14px;border:none;border-radius:10px;font-size:.8rem;
  font-weight:700;cursor:pointer;transition:all .2s;-webkit-tap-highlight-color:transparent;
}
.file-btn-dl{background:linear-gradient(135deg,#43e97b,#38f9d7);color:#1a5c3a;}
.file-btn-photo{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;}
.file-btn-del{background:linear-gradient(135deg,#ff6b6b,#ee5a24);color:#fff;}
.file-btn:hover{transform:translateY(-1px);}
.toast{
  position:fixed;bottom:30px;left:50%;
  transform:translateX(-50%) translateY(100px);
  background:rgba(0,0,0,.85);color:#fff;padding:14px 28px;
  border-radius:14px;font-size:.95rem;font-weight:600;
  opacity:0;transition:all .4s cubic-bezier(.68,-.55,.27,1.55);
  z-index:1000;pointer-events:none;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
@media(max-width:500px){
  h1{font-size:1.5rem;}.card{padding:20px;}.btn{padding:11px 14px;font-size:.85rem;}
  .file-actions{width:100%;justify-content:flex-start;margin-top:8px;}
  .global-btn{min-width:100px;padding:12px 14px;font-size:.9rem;}
}
</style>
</head>
<body>

<h1>ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆ & ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜</h1>
<p class="subtitle">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰å…±æœ‰å¯¾å¿œ â€” URLã‚’å…±æœ‰ã™ã‚‹ã ã‘ã§è¤‡æ•°ç«¯æœ«ã§åŒæœŸ</p>

<div class="container">
  <!-- å…±æœ‰URL & ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒœã‚¿ãƒ³ -->
  <div class="share-card">
    <div class="share-label">ğŸ”— å…±æœ‰URLï¼ˆã“ã®URLã‚’ä»–ã®ç«¯æœ«ã§é–‹ãã¨åŒã˜å†…å®¹ãŒè¦‹ã‚‰ã‚Œã¾ã™ï¼‰</div>
    <div class="share-url-row">
      <input type="text" class="share-url-input" id="share-url" readonly>
      <button class="global-btn global-btn-url" onclick="copyShareUrl()" style="flex:0;min-width:auto;padding:10px 16px;font-size:.85rem;">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>
  <div class="global-actions">
    <button class="global-btn global-btn-save" id="btn-cloud-save" onclick="handleCloudSave()">ğŸ’¾ ä¿å­˜ï¼ˆå…±æœ‰ï¼‰</button>
    <button class="global-btn global-btn-load" id="btn-cloud-load" onclick="handleCloudLoad()">ğŸ”„ æœ€æ–°ã‚’èª­ã¿è¾¼ã¿</button>
  </div>
  <div class="status" id="status"></div>
  <div id="app"></div>
</div>

<div class="toast" id="toast"></div>
<textarea id="copy-helper" style="position:fixed;top:-9999px;left:-9999px;opacity:0;"></textarea>

<script>
/* ========== è¨­å®š ========== */
var API = 'https://jsonblob.com/api/jsonBlob';
var LOCAL_TEXT = 'cloud_saver_texts';
var LOCAL_FILE = 'cloud_saver_files';

/* ========== ãƒ«ãƒ¼ãƒ IDç®¡ç† ========== */
function getRoomId(){ return location.hash.slice(1) || ''; }
function setRoomId(id){ location.hash = id; updateShareUrl(); }

/* ========== å…±æœ‰URL ========== */
function updateShareUrl(){
  var el = document.getElementById('share-url');
  if(el) el.value = location.href;
}
function copyShareUrl(){
  var url = location.href;
  if(navigator.clipboard && window.isSecureContext){
    navigator.clipboard.writeText(url).then(function(){ showToast('ğŸ”— URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'); });
  } else {
    var el = document.getElementById('share-url');
    el.select(); el.setSelectionRange(0,9999);
    try{ document.execCommand('copy'); showToast('ğŸ”— URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'); }
    catch(e){ showToast('âš ï¸ æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„'); }
  }
}

/* ========== ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰ ========== */
function loadTexts(){ try{ return JSON.parse(localStorage.getItem(LOCAL_TEXT))||['']; }catch(e){ return ['']; } }
function saveTexts(t){ localStorage.setItem(LOCAL_TEXT, JSON.stringify(t)); }
function loadFiles(){ try{ return JSON.parse(localStorage.getItem(LOCAL_FILE))||[[]]; }catch(e){ return [[]]; } }
function saveFiles(f){ localStorage.setItem(LOCAL_FILE, JSON.stringify(f)); }

/* ========== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º ========== */
function setStatus(msg){ document.getElementById('status').textContent = msg; }

/* ========== ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜ ========== */
async function handleCloudSave(){
  var btn = document.getElementById('btn-cloud-save');
  btn.disabled = true; btn.textContent = 'ğŸ’¾ ä¿å­˜ä¸­...';
  setStatus('');

  /* textarea ã®æœ€æ–°å€¤ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«åæ˜  */
  var texts = loadTexts();
  for(var i=0; i<texts.length; i++){
    var ta = document.getElementById('slot-'+i);
    if(ta) texts[i] = ta.value;
  }
  saveTexts(texts);

  var data = { texts: texts, files: loadFiles(), updatedAt: new Date().toISOString() };
  var roomId = getRoomId();

  try {
    if(roomId){
      var res = await fetch(API + '/' + roomId, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      showToast('â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸï¼');
    } else {
      var res = await fetch(API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      var loc = res.headers.get('Location') || '';
      var newId = loc.split('/').pop();
      if(!newId) throw new Error('IDã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
      setRoomId(newId);
      showToast('â˜ï¸ å…±æœ‰ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã—ãŸï¼URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰ã§ãã¾ã™');
    }
    setStatus('æœ€çµ‚ä¿å­˜: ' + new Date().toLocaleString('ja-JP'));
  } catch(e) {
    showToast('âš ï¸ ä¿å­˜å¤±æ•—: ' + e.message);
    setStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼');
  }
  btn.disabled = false; btn.textContent = 'ğŸ’¾ ä¿å­˜ï¼ˆå…±æœ‰ï¼‰';
}

/* ========== ã‚¯ãƒ©ã‚¦ãƒ‰èª­ã¿è¾¼ã¿ ========== */
async function handleCloudLoad(){
  var roomId = getRoomId();
  if(!roomId){ showToast('âš ï¸ ã¾ã å…±æœ‰ã‚¹ãƒšãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ä¿å­˜ã—ã¦ãã ã•ã„'); return; }

  var btn = document.getElementById('btn-cloud-load');
  btn.disabled = true; btn.textContent = 'ğŸ”„ èª­ã¿è¾¼ã¿ä¸­...';
  setStatus('');

  try {
    var res = await fetch(API + '/' + roomId);
    if(!res.ok) throw new Error('HTTP ' + res.status);
    var data = await res.json();
    if(data.texts) saveTexts(data.texts);
    if(data.files) saveFiles(data.files);
    render();
    showToast('â˜ï¸ æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼');
    if(data.updatedAt) setStatus('ãƒ‡ãƒ¼ã‚¿æ›´æ–°: ' + new Date(data.updatedAt).toLocaleString('ja-JP'));
  } catch(e) {
    showToast('âš ï¸ èª­ã¿è¾¼ã¿å¤±æ•—: ' + e.message);
    setStatus('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
  }
  btn.disabled = false; btn.textContent = 'ğŸ”„ æœ€æ–°ã‚’èª­ã¿è¾¼ã¿';
}

/* ========== ãƒˆãƒ¼ã‚¹ãƒˆ ========== */
function showToast(m){
  var t = document.getElementById('toast');
  t.textContent = m; t.classList.remove('show');
  void t.offsetWidth; t.classList.add('show');
  setTimeout(function(){ t.classList.remove('show'); }, 2000);
}

/* ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========== */
function esc(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function fmtSize(b){ if(b<1024)return b+' B'; if(b<1048576)return (b/1024).toFixed(1)+' KB'; return (b/1048576).toFixed(1)+' MB'; }
function fileIcon(n){
  var e=n.split('.').pop().toLowerCase();
  if('jpg jpeg png gif webp svg bmp ico'.split(' ').indexOf(e)>=0) return 'ğŸ–¼ï¸';
  if(e==='pdf') return 'ğŸ“„';
  if('doc docx'.split(' ').indexOf(e)>=0) return 'ğŸ“';
  if('xls xlsx csv'.split(' ').indexOf(e)>=0) return 'ğŸ“Š';
  if('mp4 mov avi webm'.split(' ').indexOf(e)>=0) return 'ğŸ¬';
  if('mp3 wav ogg m4a'.split(' ').indexOf(e)>=0) return 'ğŸµ';
  if('zip rar 7z tar gz'.split(' ').indexOf(e)>=0) return 'ğŸ“¦';
  return 'ğŸ“';
}
function isImg(n){ var e=n.split('.').pop().toLowerCase(); return 'jpg jpeg png gif webp svg bmp ico'.split(' ').indexOf(e)>=0; }

/* ========== ã‚³ãƒ”ãƒ¼ï¼ˆiOS/Android/PCå…¨å¯¾å¿œï¼‰ ========== */
function copyText(idx){
  var ta = document.getElementById('slot-'+idx);
  var text = ta ? ta.value : '';
  if(!text){ showToast('âš ï¸ ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã™'); return; }
  var texts = loadTexts(); texts[idx] = text; saveTexts(texts);

  if(navigator.clipboard && navigator.clipboard.writeText && window.isSecureContext){
    navigator.clipboard.writeText(text).then(function(){ showToast('âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'); }).catch(function(){ fallbackCopy(text,idx); });
    return;
  }
  fallbackCopy(text,idx);
}
function fallbackCopy(text,idx){
  var helper = document.getElementById('copy-helper');
  helper.style.position='fixed';helper.style.top='0';helper.style.left='0';
  helper.style.opacity='0.01';helper.style.width='1px';helper.style.height='1px';
  helper.value=text;helper.focus();helper.select();helper.setSelectionRange(0,text.length);
  var ok=false;try{ok=document.execCommand('copy');}catch(e){}
  helper.style.position='fixed';helper.style.top='-9999px';helper.style.left='-9999px';
  helper.style.opacity='0';helper.blur();
  if(ok){ showToast('âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'); }
  else {
    showToast('âš ï¸ ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¨é¸æŠã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„');
    var orig=document.getElementById('slot-'+idx);
    if(orig){orig.focus();orig.select();orig.setSelectionRange(0,orig.value.length);}
  }
}

/* ========== ãƒ­ãƒ¼ã‚«ãƒ«è‡ªå‹•ä¿å­˜ ========== */
function autoSave(idx){
  var ta=document.getElementById('slot-'+idx);
  if(!ta) return;
  var texts=loadTexts();
  while(texts.length<=idx) texts.push('');
  texts[idx]=ta.value;
  saveTexts(texts);
  var badge=ta.closest('.card').querySelector('.badge');
  if(badge) badge.textContent=ta.value.length+' æ–‡å­— / '+(loadFiles()[idx]||[]).length+' ãƒ•ã‚¡ã‚¤ãƒ«';
}

/* ========== ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ ========== */
function readFile(file){
  return new Promise(function(res,rej){
    var r=new FileReader();r.onload=function(){res(r.result);};r.onerror=rej;r.readAsDataURL(file);
  });
}
function addFiles(idx,fileList){
  var files=loadFiles();while(files.length<=idx)files.push([]);
  var promises=[];
  for(var j=0;j<fileList.length;j++){
    (function(f){
      if(f.size>5*1024*1024){showToast('âš ï¸ 5MBè¶…ã‚¹ã‚­ãƒƒãƒ—: '+f.name);return;}
      promises.push(readFile(f).then(function(dataUrl){
        files[idx].push({name:f.name,size:f.size,type:f.type,data:dataUrl});
      }));
    })(fileList[j]);
  }
  Promise.all(promises).then(function(){saveFiles(files);render();showToast('ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸ');});
}
function toBlob(dataUrl){
  var parts=dataUrl.split(',');var mime=parts[0].match(/:(.*?);/)[1];
  var raw=atob(parts[1]);var u8=new Uint8Array(raw.length);
  for(var i=0;i<raw.length;i++)u8[i]=raw.charCodeAt(i);
  return new Blob([u8],{type:mime});
}
function downloadFile(si,fi){
  var f=loadFiles()[si][fi];var blob=toBlob(f.data);var url=URL.createObjectURL(blob);
  var a=document.createElement('a');a.href=url;a.download=f.name;
  document.body.appendChild(a);a.click();
  setTimeout(function(){document.body.removeChild(a);URL.revokeObjectURL(url);},200);
  showToast('â¬‡ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹');
}
function saveToPhotos(si,fi){
  var f=loadFiles()[si][fi];var blob=toBlob(f.data);
  var file;try{file=new File([blob],f.name,{type:f.type||blob.type});}catch(e){file=blob;}
  if(navigator.canShare&&navigator.canShare({files:[file]})){
    navigator.share({files:[file],title:f.name}).then(function(){
      showToast('ğŸ“· å…±æœ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ä¿å­˜ã§ãã¾ã™');
    }).catch(function(e){if(e.name!=='AbortError')openImageTab(f);});
    return;
  }
  openImageTab(f);
}
function openImageTab(f){
  var w=window.open('','_blank');
  if(w){
    w.document.write('<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width,initial-scale=1"><title>'+esc(f.name)+'</title><style>body{margin:0;display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh;background:#111;}img{max-width:100%;max-height:90vh;object-fit:contain;}p{color:#fff;text-align:center;padding:20px;font-family:sans-serif;font-size:14px;}</style></head><body><img src="'+f.data+'"><p>ğŸ“· ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ã€Œå†™çœŸã«è¿½åŠ ã€ã‚’é¸ã‚“ã§ãã ã•ã„</p></body></html>');
    w.document.close();showToast('ğŸ“· é•·æŠ¼ã—ã§å†™çœŸã«ä¿å­˜ã§ãã¾ã™');
  }else{showToast('âš ï¸ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');}
}
function deleteFile(si,fi){
  var files=loadFiles();if(!files[si])return;
  files[si].splice(fi,1);saveFiles(files);render();showToast('ğŸ—‘ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}

/* ========== ã‚¹ãƒ­ãƒƒãƒˆè¿½åŠ ãƒ»å‰Šé™¤ ========== */
function addSlot(){
  var texts=loadTexts();texts.push('');saveTexts(texts);
  var files=loadFiles();files.push([]);saveFiles(files);
  render();showToast('â• æ–°ã—ã„ã‚¹ãƒ­ãƒƒãƒˆã‚’è¿½åŠ ');
  setTimeout(function(){window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});},100);
}
function deleteSlot(i){
  var texts=loadTexts();texts.splice(i,1);if(!texts.length)texts.push('');saveTexts(texts);
  var files=loadFiles();files.splice(i,1);if(!files.length)files.push([]);saveFiles(files);
  render();showToast('ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ');
}

/* ========== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ========== */
function render(){
  var app=document.getElementById('app');
  var texts=loadTexts();var allFiles=loadFiles();
  var colors=['#667eea','#43e97b','#f093fb','#f5576c','#38f9d7','#ffa751','#36d1dc'];
  var html='';

  for(var i=0;i<texts.length;i++){
    var text=texts[i];var c=colors[i%colors.length];var sf=allFiles[i]||[];
    html+='<div class="card">';
    html+='<div class="card-header"><span class="card-title" style="color:'+c+'">ğŸ“ ã‚¹ãƒ­ãƒƒãƒˆ '+(i+1)+'</span>';
    html+='<span class="badge">'+text.length+' æ–‡å­— / '+sf.length+' ãƒ•ã‚¡ã‚¤ãƒ«</span></div>';
    html+='<span class="slot-label">ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ï¼ˆæ”¹è¡Œã‚‚ãã®ã¾ã¾ä¿å­˜ï¼†ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã™ï¼‰</span>';
    html+='<textarea id="slot-'+i+'" placeholder="ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›..." oninput="autoSave('+i+')">'+esc(text)+'</textarea>';
    html+='<div class="btn-group">';
    html+='<button class="btn btn-copy" onclick="copyText('+i+')">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>';
    html+='<button class="btn btn-file" onclick="document.getElementById(\'fi-'+i+'\').click()">ğŸ“ è¿½åŠ </button>';
    html+='<input type="file" id="fi-'+i+'" multiple style="display:none" onchange="addFiles('+i+',this.files);this.value=\'\';">';
    html+='<button class="btn btn-delete" onclick="deleteSlot('+i+')">ğŸ—‘ï¸</button>';
    html+='</div>';
    html+='<div class="drop-zone" id="dz-'+i+'" onclick="document.getElementById(\'fi-'+i+'\').click()">';
    html+='ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— or ã‚¯ãƒªãƒƒã‚¯<br><span style="font-size:.75rem;color:#bbb;">ç”»åƒãƒ»PDFãƒ»å…¨ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œï¼ˆ5MBã¾ã§ï¼‰</span></div>';

    if(sf.length){
      html+='<div class="file-list">';
      for(var fi=0;fi<sf.length;fi++){
        var f=sf[fi];
        html+='<div class="file-item">';
        html+='<span class="file-icon">'+fileIcon(f.name)+'</span>';
        html+='<div class="file-info"><div class="file-name">'+esc(f.name)+'</div><div class="file-size">'+fmtSize(f.size)+'</div>';
        if(isImg(f.name)) html+='<img src="'+f.data+'" class="file-preview">';
        html+='</div>';
        html+='<div class="file-actions">';
        if(isImg(f.name)) html+='<button class="file-btn file-btn-photo" onclick="saveToPhotos('+i+','+fi+')">ğŸ“· å†™çœŸã‚’ä¿å­˜</button>';
        html+='<button class="file-btn file-btn-dl" onclick="downloadFile('+i+','+fi+')">â¬‡ï¸ DL</button>';
        html+='<button class="file-btn file-btn-del" onclick="deleteFile('+i+','+fi+')">ğŸ—‘ï¸</button>';
        html+='</div></div>';
      }
      html+='</div>';
    }
    html+='</div>';
  }

  html+='<button class="btn btn-add" onclick="addSlot()" style="border-radius:16px;padding:16px;width:100%;">â• æ–°ã—ã„ã‚¹ãƒ­ãƒƒãƒˆã‚’è¿½åŠ </button>';
  app.innerHTML=html;

  for(var k=0;k<texts.length;k++){
    (function(idx){
      var dz=document.getElementById('dz-'+idx);if(!dz)return;
      dz.addEventListener('dragover',function(e){e.preventDefault();dz.classList.add('drag-over');});
      dz.addEventListener('dragleave',function(){dz.classList.remove('drag-over');});
      dz.addEventListener('drop',function(e){e.preventDefault();dz.classList.remove('drag-over');addFiles(idx,e.dataTransfer.files);});
    })(k);
  }
}

/* ========== åˆæœŸåŒ– ========== */
(async function init(){
  updateShareUrl();
  window.addEventListener('hashchange', updateShareUrl);
  var roomId = getRoomId();

  if(roomId){
    setStatus('â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
    try{
      var res = await fetch(API+'/'+roomId);
      if(res.ok){
        var data = await res.json();
        if(data.texts) saveTexts(data.texts);
        if(data.files) saveFiles(data.files);
        setStatus('â˜ï¸ èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆ'+new Date(data.updatedAt).toLocaleString('ja-JP')+'ï¼‰');
      } else {
        setStatus('âš ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }
    }catch(e){
      setStatus('âš ï¸ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰');
    }
  } else {
    setStatus('ğŸ’¡ã€Œä¿å­˜ï¼ˆå…±æœ‰ï¼‰ã€ãƒœã‚¿ãƒ³ã§å…±æœ‰ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã§ãã¾ã™');
  }
  render();
})();
</script>

</body>
</html>
